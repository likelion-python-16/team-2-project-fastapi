name: Deploy to EC2

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      run: |
        # í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ ìˆì„ ë•Œ ì‹¤í–‰
        # pytest
        echo "Tests passed"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        port: 22
        timeout: 30s
        command_timeout: 15m
        script: |
          cd /home/ec2-user/myapp/team-project

          echo "ğŸš€ Starting deployment..."
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ“‚ Directory contents:"
          ls -la

          # Git pullë¡œ ìµœì‹  ì½”ë“œ ë°›ê¸°
          echo "ğŸ“¥ Pulling latest code..."
          git pull origin main
          
          # Docker í™˜ê²½ í™•ì¸
          echo "ğŸ³ Docker version:"
          docker --version
          docker-compose --version

          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          echo "ğŸ§¹ Cleaning up existing containers..."
          docker-compose down --remove-orphans || echo "No containers to stop"

          # Docker ì´ë¯¸ì§€ ì •ë¦¬
          echo "ğŸ—‘ï¸ Cleaning up unused Docker resources..."
          docker system prune -f

          # í™˜ê²½ ë³€ìˆ˜ í™•ì¸ (ë¯¼ê° ì •ë³´ ì œì™¸)
          echo "âš™ï¸ Environment check:"
          echo "USER: $USER"
          echo "PWD: $PWD"

          # ìƒˆ ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì‹œì‘
          echo "ğŸ”¨ Building and starting containers..."
          docker-compose up -d --build --force-recreate

          echo "â³ Waiting 20 seconds for initial startup..."
          sleep 20

          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo "ğŸ“‹ Container status:"
          docker-compose ps

          # í¬íŠ¸ í™•ì¸
          echo "ğŸ”Œ Port status:"
          netstat -tlnp | grep :8000 || echo "Port 8000 not found"

          # ë¡œê·¸ í™•ì¸
          echo "ğŸ“ Recent API logs:"
          docker-compose logs --tail=30 team-api

          # ê¸°ë³¸ ì—°ê²° í…ŒìŠ¤íŠ¸
          echo "ğŸ” Testing basic connectivity..."

          for attempt in {1..8}; do
            echo "Health check attempt $attempt/8..."

          # ë¨¼ì € í¬íŠ¸ê°€ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸
            if nc -z localhost 8000; then
              echo "âœ… Port 8000 is accessible"

              # í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
              if curl -f -s --connect-timeout 5 --max-time 10 http://localhost:8000/health; then
                echo "âœ… Health check passed!"
                echo "ğŸ‰ Deployment successful!"

                # ì¶”ê°€ ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
                echo "ğŸ§ª Testing additional endpoints:"
                curl -s http://localhost:8000/ | head -3

                exit 0
              else
                echo "âŒ Health endpoint failed"
                curl -v http://localhost:8000/health || true
              fi
            else
              echo "âŒ Port 8000 not accessible"
            fi

            if [ $attempt -eq 8 ]; then
              echo "ğŸ’¥ All attempts failed!"
              echo "ğŸ” Final debugging info:"
              echo "--- All Container Logs ---"
              docker-compose logs
              exit 1
            else
              echo "â³ Waiting 15 seconds before next attempt..."
              sleep 15
            fi
          done